name: Export Game

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest
    env:
      GODOT_VERSION: "4.5-stable"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y unzip

      - name: Download Godot
        run: |
          set -euo pipefail
          mkdir -p tools/godot
          curl -L -o tools/godot/godot.zip \
            "https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}/Godot_v${GODOT_VERSION}_linux.x86_64.zip"
          unzip -q tools/godot/godot.zip -d tools/godot
          chmod +x tools/godot/Godot_v${GODOT_VERSION}_linux.x86_64

      - name: Install export templates
        run: |
          set -euo pipefail
          mkdir -p /tmp/godot-templates
          curl -L -o /tmp/godot-templates/templates.tpz \
            "https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}/Godot_v${GODOT_VERSION}_export_templates.tpz"
          TEMPLATE_VERSION="${GODOT_VERSION/-/.}"
          TEMPLATE_DIR="${HOME}/.local/share/godot/export_templates/${TEMPLATE_VERSION}"
          mkdir -p "${TEMPLATE_DIR}"
          unzip -q /tmp/godot-templates/templates.tpz -d "${TEMPLATE_DIR}"
          if [ -d "${TEMPLATE_DIR}/templates" ]; then
            mv "${TEMPLATE_DIR}/templates/"* "${TEMPLATE_DIR}/"
            rmdir "${TEMPLATE_DIR}/templates"
          fi

      - name: Export
        env:
          GODOT_BIN: ${{ github.workspace }}/tools/godot/Godot_v${{ env.GODOT_VERSION }}_linux.x86_64
        run: |
          set -euo pipefail
          bash scripts/export.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: game-exports
          path: export/**
